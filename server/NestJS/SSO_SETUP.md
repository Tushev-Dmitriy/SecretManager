# Simple SSO Authentication with Keycloak

–ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ SSO –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Keycloak –¥–ª—è NestJS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ Keycloak

```bash
cd keycloak
docker-compose up -d
```

–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–ø—É—Å–∫–∞ Keycloak (1-2 –º–∏–Ω—É—Ç—ã), –∑–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak

#### –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å

- URL: http://localhost:8080
- Username: `admin`
- Password: `admin_password`

#### –°–æ–∑–¥–∞–Ω–∏–µ Realm

1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ realm (—Å–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞)
2. –í—ã–±–µ—Ä–∏—Ç–µ "Create realm"
3. Name: `corporate-secrets`
4. –ù–∞–∂–º–∏—Ç–µ "Create"

#### –°–æ–∑–¥–∞–Ω–∏–µ Client

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Clients" ‚Üí "Create client"
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - Client ID: `secrets-app`
   - Client type: `OpenID Connect`
3. –ù–∞–∂–º–∏—Ç–µ "Next"
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏:
   - Client authentication: `ON`
5. –ù–∞–∂–º–∏—Ç–µ "Next"
6. Valid redirect URIs: `http://localhost:3000/auth/callback`
7. –ù–∞–∂–º–∏—Ç–µ "Save"

#### –ü–æ–ª—É—á–µ–Ω–∏–µ Client Secret

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "Credentials" —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ client
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ "Client secret"
3. –û–±–Ω–æ–≤–∏—Ç–µ `KEYCLOAK_CLIENT_SECRET` –≤ .env —Ñ–∞–π–ª–µ

#### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Users" ‚Üí "Create new user"
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - Username: `testuser`
   - Email: `test@example.com`
   - First name: `Test`
   - Last name: `User`
3. –ù–∞–∂–º–∏—Ç–µ "Create"
4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Credentials" ‚Üí "Set password"
5. Password: `password123`
6. –°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É "Temporary"

### 3. –ó–∞–ø—É—Å–∫ NestJS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
yarn install

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
yarn start:dev
```

## üîß API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### 1. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –≤—Ö–æ–¥–∞

```
GET http://localhost:3000/auth/login
```

–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –≤ Keycloak –¥–ª—è –≤—Ö–æ–¥–∞

#### 2. Callback (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

```
GET http://localhost:3000/auth/callback
```

Keycloak –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç —Å—é–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### 3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```
GET http://localhost:3000/auth/success?token=<jwt-token>
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
GET http://localhost:3000/auth/profile
Authorization: Bearer <your-jwt-token>
```

## üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞:

```
http://localhost:3000/auth/login
```

### 2. –í–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –≤ Keycloak –¥–ª—è –≤—Ö–æ–¥–∞

- –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω: `testuser`
- –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å: `password123`

### 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –≤–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞:

```
http://localhost:3001/auth/success?token=<jwt-token>
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º:

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
     http://localhost:3000/auth/profile
```

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à `.env` —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç:

```env
DATABASE_URL=postgresql://postgres.hfqrijwbxklnuaszsxmb:biteTheDust@aws-1-eu-north-1.pooler.supabase.com:5432/postgres
KEYCLOAK_ISSUER=http://localhost:8080/realms/corporate-secrets
KEYCLOAK_INTERNAL_URL=http://keycloak:8080/realms/corporate-secrets
KEYCLOAK_CLIENT_ID=secrets-app
KEYCLOAK_CLIENT_SECRET=your-actual-client-secret-from-keycloak
KEYCLOAK_REDIRECT_URI=http://localhost:3000/auth/callback
JWT_SECRET=32c06da051ca95a5449f0d3b881473281be38c106dd0b92665cfdf2a2c512a69
SESSION_SECRET=5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d
```

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **Keycloak Server** (–ø–æ—Ä—Ç 8080)
   - –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - OAuth2/OIDC –ø—Ä–æ–≤–∞–π–¥–µ—Ä

2. **NestJS Backend** (–ø–æ—Ä—Ç 3000)
   - REST API
   - JWT —Ç–æ–∫–µ–Ω—ã
   - Passport.js –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ `/auth/login`
2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ Keycloak –¥–ª—è –≤—Ö–æ–¥–∞
3. Keycloak –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. –û–±—Ä–∞—Ç–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `/auth/callback`
5. –°–æ–∑–¥–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞
6. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å —Ç–æ–∫–µ–Ω–æ–º

## üêõ Troubleshooting

### Keycloak –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase

### –û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Client Secret –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ redirect URIs –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö client
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ realm `corporate-secrets` —Å–æ–∑–¥–∞–Ω

### JWT –æ—à–∏–±–∫–∏

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT_SECRET –≤ .env
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization

## üìö –ß—Ç–æ –¥–∞–ª—å—à–µ?

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–∞–∑–æ–≤—É—é SSO –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é. –í—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –µ–µ:

1. –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
2. –°–æ–∑–¥–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
